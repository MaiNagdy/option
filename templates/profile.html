<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - OptionAnalytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="/" class="flex items-center space-x-2 hover:opacity-80 transition">
                        <i class="fas fa-chart-line text-2xl text-purple-500"></i>
                        <span class="text-xl font-bold">OptionAnalytics</span>
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="/dashboard" class="px-3 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700 transition">
                            <i class="fas fa-home mr-2"></i>Dashboard
                        </a>
                        <a href="/profile" class="px-3 py-2 rounded-lg bg-gray-700 text-white font-medium">
                            <i class="fas fa-user mr-2"></i>Profile
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-400 hidden md:block">{{ user.name }}</span>
                    <span class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-sm font-semibold capitalize">
                        {{ user.plan }}
                    </span>
                    <a href="/logout" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Account Settings</h1>
            <p class="text-gray-400">Manage your profile and subscription</p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- Profile Info Card -->
            <div class="md:col-span-2 space-y-6">
                <!-- Account Information -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-user-circle mr-2 text-purple-500"></i>Account Information</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                            <input 
                                type="text" 
                                id="profileName"
                                value="{{ user.name }}"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                            <input 
                                type="email" 
                                id="profileEmail"
                                value="{{ user.email }}"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition"
                                readonly
                                title="Email cannot be changed"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Member Since</label>
                            <input 
                                type="text" 
                                value="September 2025"
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg"
                                readonly
                            >
                        </div>

                        <button 
                            onclick="saveProfileSettings()"
                            class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition"
                        >
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </div>

                <!-- Current Plan -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-crown mr-2 text-purple-500"></i>Current Plan</h2>
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-3xl font-bold capitalize">{{ user.plan }}</h3>
                            <p class="text-gray-400">
                                {% if user.plan == 'free' %}
                                5 stocks per analysis
                                {% elif user.plan == 'pro' %}
                                Unlimited stocks, Real-time data
                                {% else %}
                                Everything + API Access
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">
                                {% if user.plan == 'free' %}
                                $0
                                {% elif user.plan == 'pro' %}
                                $29
                                {% else %}
                                Custom
                                {% endif %}
                            </div>
                            <div class="text-gray-400 text-sm">/month</div>
                        </div>
                    </div>

                    {% if user.plan == 'free' %}
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>5 stocks per analysis</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Basic metrics</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>CSV export</span>
                        </div>
                        <div class="flex items-center text-gray-500">
                            <i class="fas fa-times text-red-500 mr-3"></i>
                            <span>Unlimited stocks</span>
                        </div>
                        <div class="flex items-center text-gray-500">
                            <i class="fas fa-times text-red-500 mr-3"></i>
                            <span>Real-time data</span>
                        </div>
                    </div>
                    
                    <button onclick="upgradeToPro()" class="w-full gradient-bg py-3 rounded-lg font-bold text-lg hover:shadow-lg transition">
                        <i class="fas fa-arrow-up mr-2"></i>Upgrade to Pro - $29/month
                    </button>
                    {% endif %}

                    {% if user.plan == 'pro' %}
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Unlimited stocks</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>All valuation models</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Real-time data</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span>Priority support</span>
                        </div>
                    </div>
                    
                    <button onclick="cancelSubscription()" class="w-full bg-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-600 transition">
                        Cancel Subscription
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Usage Stats Sidebar -->
            <div class="space-y-6">
                <!-- Usage Card -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-bar mr-2 text-purple-500"></i>Usage Stats</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-400">Analyses This Month</span>
                                <span class="font-bold">12 / âˆž</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: 40%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-400">Stocks Analyzed</span>
                                <span class="font-bold">240</span>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-400">CSV Downloads</span>
                                <span class="font-bold">8</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <a href="/dashboard" class="block w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-center transition">
                            <i class="fas fa-chart-line mr-2"></i>New Analysis
                        </a>
                        <button onclick="viewHistory()" class="block w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition">
                            <i class="fas fa-history mr-2"></i>View History
                        </button>
                        <button onclick="exportSettings()" class="block w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition">
                            <i class="fas fa-cog mr-2"></i>Export Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-gray-800 rounded-xl max-w-6xl w-full my-8 border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800 rounded-t-xl">
                <h2 class="text-2xl font-bold"><i class="fas fa-history mr-2 text-purple-500"></i>Analysis History</h2>
                <div class="flex gap-3">
                    <button onclick="downloadHistoryCSV()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="historyContent" class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-purple-500 mb-4"></i>
                    <p class="text-gray-400">Loading history...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stripe Payment Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl max-w-md w-full p-8 border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Upgrade to Pro</h2>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <div class="bg-purple-500/20 border border-purple-500 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Pro Plan</span>
                        <span class="text-2xl font-bold">$29<span class="text-sm text-gray-400">/month</span></span>
                    </div>
                </div>

                <div class="space-y-2 mb-6">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-check text-green-500 mr-2"></i>
                        <span>Unlimited stock analyses</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-check text-green-500 mr-2"></i>
                        <span>Real-time option data</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-check text-green-500 mr-2"></i>
                        <span>All intrinsic value models</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-check text-green-500 mr-2"></i>
                        <span>Priority support</span>
                    </div>
                </div>

                <!-- Stripe Payment Form -->
                <div id="payment-form">
                    <div id="card-element" class="p-4 bg-gray-700 rounded-lg border border-gray-600 mb-4">
                        <!-- Stripe card element will be inserted here -->
                    </div>
                    <div id="card-errors" class="text-red-400 text-sm mb-4"></div>

                    <button onclick="processPayment()" id="payButton" class="w-full gradient-bg py-3 rounded-lg font-bold hover:shadow-lg transition">
                        <i class="fas fa-lock mr-2"></i>Subscribe Now - $29/month
                    </button>
                </div>

                <p class="text-xs text-gray-400 text-center mt-4">
                    Secure payment powered by Stripe. Cancel anytime.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Stripe Configuration
        // Use test publishable key - replace with your actual key in production
        const STRIPE_PUBLIC_KEY = 'pk_test_51234567890abcdefghijklmnopqrstuvwxyz'; // Replace with your key
        
        let stripe = null;
        let cardElement = null;
        let isStripeConfigured = false;

        // Initialize Stripe when modal opens
        function upgradeToPro() {
            document.getElementById('paymentModal').classList.remove('hidden');
            setTimeout(() => {
                initializeStripe();
            }, 100);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            if (cardElement) {
                cardElement.clear();
            }
        }

        async function initializeStripe() {
            const cardElementDiv = document.getElementById('card-element');
            const errorDiv = document.getElementById('card-errors');
            
            try {
                // Check if Stripe is configured
                const configResponse = await fetch('/api/stripe-config');
                const config = await configResponse.json();
                
                if (config.publicKey && config.publicKey !== 'not_configured') {
                    // Real Stripe integration
                    stripe = Stripe(config.publicKey);
                    const elements = stripe.elements();
                    
                    cardElement = elements.create('card', {
                        style: {
                            base: {
                                color: '#ffffff',
                                fontFamily: 'Inter, sans-serif',
                                fontSize: '16px',
                                '::placeholder': {
                                    color: '#9ca3af',
                                },
                            },
                            invalid: {
                                color: '#ef4444',
                            },
                        },
                    });
                    
                    cardElement.mount('#card-element');
                    
                    cardElement.on('change', (event) => {
                        if (event.error) {
                            errorDiv.textContent = event.error.message;
                            errorDiv.className = 'text-red-400 text-sm mb-4';
                        } else {
                            errorDiv.textContent = '';
                        }
                    });
                    
                    isStripeConfigured = true;
                } else {
                    // Demo/Test mode with manual card input
                    setupTestMode();
                }
            } catch (error) {
                console.error('Stripe initialization error:', error);
                setupTestMode();
            }
        }

        function setupTestMode() {
            const cardElementDiv = document.getElementById('card-element');
            const errorDiv = document.getElementById('card-errors');
            
            cardElementDiv.innerHTML = `
                <div class="text-yellow-400 text-xs mb-3">
                    <i class="fas fa-info-circle mr-2"></i>Demo Mode - Use test card: 4242 4242 4242 4242
                </div>
                <input 
                    type="text" 
                    id="testCardNumber"
                    placeholder="Card number (4242 4242 4242 4242)"
                    maxlength="19"
                    class="w-full px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white focus:ring-2 focus:ring-purple-500 outline-none mb-3"
                    oninput="formatCardNumber(this); validateTestCard();"
                >
                <div class="grid grid-cols-2 gap-3">
                    <input 
                        type="text" 
                        id="testExpiry"
                        placeholder="MM/YY"
                        maxlength="5"
                        class="px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white focus:ring-2 focus:ring-purple-500 outline-none"
                        oninput="formatExpiry(this); validateTestCard();"
                    >
                    <input 
                        type="text" 
                        id="testCvc"
                        placeholder="CVC"
                        maxlength="3"
                        class="px-4 py-3 bg-gray-600 border border-gray-500 rounded-lg text-white focus:ring-2 focus:ring-purple-500 outline-none"
                        oninput="validateTestCard();"
                    >
                </div>
            `;
            
            errorDiv.innerHTML = '<span class="text-blue-400"><i class="fas fa-lightbulb mr-2"></i>Stripe not configured - Using test mode</span>';
            isStripeConfigured = false;
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        function formatExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }

        function validateTestCard() {
            const errorDiv = document.getElementById('card-errors');
            const cardNumber = document.getElementById('testCardNumber')?.value.replace(/\s/g, '');
            const expiry = document.getElementById('testExpiry')?.value;
            const cvc = document.getElementById('testCvc')?.value;
            
            if (!cardNumber || !expiry || !cvc) return;
            
            // Validate test card
            if (cardNumber === '4242424242424242' && expiry.length === 5 && cvc.length === 3) {
                errorDiv.innerHTML = '<span class="text-green-400"><i class="fas fa-check-circle mr-2"></i>Test card validated</span>';
                return true;
            } else if (cardNumber.length === 16) {
                errorDiv.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i>Use test card: 4242 4242 4242 4242</span>';
                return false;
            }
            return false;
        }

        async function processPayment() {
            const payButton = document.getElementById('payButton');
            const errorDiv = document.getElementById('card-errors');
            
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing payment...';
            errorDiv.className = 'text-sm mb-4';

            try {
                if (isStripeConfigured && stripe && cardElement) {
                    // Real Stripe payment
                    const {error, paymentMethod} = await stripe.createPaymentMethod({
                        type: 'card',
                        card: cardElement,
                    });

                    if (error) {
                        throw new Error(error.message);
                    }

                    // Send payment method to server
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            paymentMethodId: paymentMethod.id,
                            plan: 'pro',
                            amount: 2900 // $29.00 in cents
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || 'Payment failed');
                    }

                    // Handle response
                    if (result.requiresAction) {
                        // Handle 3D Secure
                        const {error: confirmError} = await stripe.confirmCardPayment(result.clientSecret);
                        if (confirmError) {
                            throw new Error(confirmError.message);
                        }
                    }

                    showSuccessMessage();
                    
                } else {
                    // Test mode payment
                    const cardNumber = document.getElementById('testCardNumber')?.value.replace(/\s/g, '');
                    const expiry = document.getElementById('testExpiry')?.value;
                    const cvc = document.getElementById('testCvc')?.value;

                    if (!cardNumber || cardNumber !== '4242424242424242') {
                        throw new Error('Invalid test card. Use: 4242 4242 4242 4242');
                    }

                    if (!expiry || expiry.length !== 5) {
                        throw new Error('Invalid expiry date. Format: MM/YY');
                    }

                    if (!cvc || cvc.length !== 3) {
                        throw new Error('Invalid CVC. Must be 3 digits');
                    }

                    // Simulate processing
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Send to server to upgrade account
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            testMode: true,
                            plan: 'pro',
                            cardNumber: cardNumber.slice(-4)
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Subscription failed');
                    }

                    showSuccessMessage();
                }

            } catch (error) {
                console.error('Payment error:', error);
                errorDiv.innerHTML = `<span class="text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>${error.message || 'Payment failed. Please try again.'}</span>`;
                payButton.disabled = false;
                payButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Subscribe Now - $29/month';
            }
        }

        function showSuccessMessage() {
            closePaymentModal();
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-slide-in';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-check-circle text-2xl"></i>
                    <div>
                        <div class="font-bold text-lg">Subscription Successful! ðŸŽ‰</div>
                        <div class="text-sm">Welcome to Pro - Reloading page...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Add animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slide-in {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                .animate-slide-in { animation: slide-in 0.3s ease-out; }
            `;
            document.head.appendChild(style);
            
            // Reload after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        function cancelSubscription() {
            showConfirmModal(
                'Cancel Subscription',
                'Are you sure you want to cancel your subscription? You will retain access until the end of your billing period.',
                () => {
                    fetch('/api/cancel-subscription', {method: 'POST'})
                        .then(response => {
                            if (response.ok) {
                                showToast('Subscription cancelled successfully. You will retain access until the end of your billing period.', 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            } else {
                                showToast('Failed to cancel subscription. Please try again.', 'error');
                            }
                        })
                        .catch(error => {
                            showToast('Error: ' + error.message, 'error');
                        });
                }
            );
        }

        // Custom confirmation modal
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl max-w-md w-full border border-gray-700 transform scale-95 opacity-0 transition-all duration-200" id="confirmModalContent">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-3">${title}</h3>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex gap-3">
                            <button onclick="closeConfirmModal()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition">
                                Cancel
                            </button>
                            <button onclick="confirmAction()" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate in
            setTimeout(() => {
                const content = document.getElementById('confirmModalContent');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Store callback
            window.confirmCallback = onConfirm;
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) closeConfirmModal();
            };
        }

        function closeConfirmModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/80');
            if (modal) {
                const content = document.getElementById('confirmModalContent');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.remove(), 200);
            }
        }

        function confirmAction() {
            if (window.confirmCallback) {
                window.confirmCallback();
                delete window.confirmCallback;
            }
            closeConfirmModal();
        }

        let historyData = [];

        async function viewHistory() {
            // Show modal
            document.getElementById('historyModal').classList.remove('hidden');
            
            // Fetch history from API
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                historyData = data.history || [];
                
                displayHistory(historyData);
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContent').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="text-gray-400">Failed to load history. Please try again.</p>
                    </div>
                `;
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function displayHistory(history) {
            const content = document.getElementById('historyContent');
            
            if (history.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
                        <p class="text-xl text-gray-400 mb-2">No analysis history yet</p>
                        <p class="text-gray-500">Run your first analysis to see it here!</p>
                        <a href="/dashboard" class="inline-block mt-4 px-6 py-3 gradient-bg rounded-lg font-semibold hover:shadow-lg transition">
                            <i class="fas fa-chart-line mr-2"></i>Start Analysis
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="space-y-6">';
            
            history.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="bg-gray-700/50 rounded-xl p-6 border border-gray-600 hover:border-purple-500/50 transition">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-purple-400 mb-1">
                                    <i class="fas fa-calendar-alt mr-2"></i>${dateStr} at ${timeStr}
                                </h3>
                                <p class="text-gray-400 text-sm">
                                    Analyzed: ${entry.symbols.join(', ')}
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-semibold">
                                    ${entry.results_count} results
                                </span>
                                ${entry.errors_count > 0 ? `
                                    <span class="ml-2 px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm font-semibold">
                                        ${entry.errors_count} errors
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${entry.results && entry.results.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="text-left text-gray-400 border-b border-gray-600">
                                        <tr>
                                            <th class="pb-2">Symbol</th>
                                            <th class="pb-2">Strategy</th>
                                            <th class="pb-2 text-right">Price</th>
                                            <th class="pb-2 text-right">Strike</th>
                                            <th class="pb-2 text-right">Premium</th>
                                            <th class="pb-2 text-right">Return %</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-200">
                                        ${entry.results.slice(0, 5).map(result => `
                                            <tr class="border-b border-gray-600/50">
                                                <td class="py-2 font-bold text-purple-400">${result.symbol}</td>
                                                <td class="py-2">
                                                    <span class="px-2 py-0.5 rounded text-xs ${result.strategy === 'Covered Call' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">
                                                        ${result.strategy}
                                                    </span>
                                                </td>
                                                <td class="py-2 text-right">$${result.current_price?.toFixed(2) || 'N/A'}</td>
                                                <td class="py-2 text-right">$${result.strike_price?.toFixed(2) || 'N/A'}</td>
                                                <td class="py-2 text-right text-green-400">$${result.premium_total?.toFixed(2) || 'N/A'}</td>
                                                <td class="py-2 text-right font-bold text-purple-400">${result.return_percentage?.toFixed(2) || 'N/A'}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${entry.results.length > 5 ? `
                                    <p class="text-gray-400 text-sm mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Showing 5 of ${entry.results.length} results
                                    </p>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${entry.errors && Object.keys(entry.errors).length > 0 ? `
                            <div class="mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                <p class="text-yellow-500 font-semibold mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Errors:
                                </p>
                                ${Object.entries(entry.errors).map(([symbol, error]) => `
                                    <p class="text-sm text-gray-300 ml-4">â€¢ <span class="font-bold">${symbol}:</span> ${error}</p>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function downloadHistoryCSV() {
            if (historyData.length === 0) {
                showToast('No history to export', 'warning');
                return;
            }
            
            // Create CSV from all history
            let csvContent = 'Date,Time,Symbol,Strategy,Current Price,Strike,Premium,Return %,IV %,Intrinsic Value,DCF Value,Wall St Target\n';
            
            historyData.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-US');
                const timeStr = date.toLocaleTimeString('en-US');
                
                entry.results.forEach(result => {
                    csvContent += [
                        dateStr,
                        timeStr,
                        result.symbol,
                        result.strategy,
                        result.current_price?.toFixed(2) || '',
                        result.strike_price?.toFixed(2) || '',
                        result.premium_total?.toFixed(2) || '',
                        result.return_percentage?.toFixed(2) || '',
                        result.implied_volatility ? (result.implied_volatility * 100).toFixed(1) : '',
                        result.lynch_fair_value?.toFixed(2) || '',
                        result.dcf_intrinsic_value?.toFixed(2) || '',
                        result.analyst_target?.toFixed(2) || ''
                    ].join(',') + '\n';
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analysis_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('History exported successfully!', 'success');
        }

        function exportSettings() {
            // Create JSON settings
            const settings = {
                user: {
                    name: "{{ user.name }}",
                    email: "{{ user.email }}",
                    plan: "{{ user.plan }}"
                },
                preferences: {
                    defaultStocks: ['NVDA', 'MSFT', 'GOOG', 'AAPL'],
                    targetDays: 30,
                    theme: 'dark',
                    notifications: true
                },
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `settings_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Save profile settings
        async function saveProfileSettings() {
            const name = document.getElementById('profileName').value.trim();
            
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/update-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name })
                });

                if (response.ok) {
                    showToast('Profile updated successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                showToast('Error updating profile: ' + error.message, 'error');
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = 'toast-slide';
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center space-x-3 min-w-[300px]">
                    <i class="fas ${icons[type]} text-xl"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(container);
            
            const style = document.createElement('style');
            style.textContent = `
                .toast-slide {
                    transform: translateX(400px);
                    opacity: 0;
                    transition: all 0.3s ease-out;
                }
                .toast-slide.show {
                    transform: translateX(0);
                    opacity: 1;
                }
            `;
            document.head.appendChild(style);
            
            return container;
        }
    </script>
</body>
</html>
